<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <title>Network Graph — Interactive (drag, release, toggle physics)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    :root{--accent:#3c82ff;--bg:#f6f8fb}
    html,body{height:100%;margin:0;font-family:Inter, Arial, Helvetica, sans-serif;background:var(--bg)}
    header{display:flex;gap:8px;align-items:center;padding:10px;background:#fff;border-bottom:1px solid #e6e9f2}
    .hint{color:#666;font-size:13px}
    #graph{width:100vw;height:calc(100vh - 56px);display:block}
    button{background:var(--accent);color:#fff;border:none;padding:8px 10px;border-radius:6px;cursor:pointer}
    button.secondary{background:#fff;color:#333;border:1px solid #d0d7ee}
    input[type=file]{padding:6px}
    .controls{display:flex;gap:8px;align-items:center}
  </style>
</head>
<body>
  <header>
    <input id="fileInput" type="file" accept=".csv" title="Chọn file CSV (header: source,target[,size,color])" />
    <div class="controls">
      <button id="fit">Fit View</button>
      <button id="togglePhysics" class="secondary">Tạm dừng physics</button>
      <button id="exportPng" class="secondary">Export PNG</button>
    </div>
    <div style="flex:1"></div>
    <div class="hint">Mở bằng Live Server. Đặt <code>network-data.csv</code> cùng thư mục hoặc chọn file thủ công.</div>
  </header>

  <svg id="graph"></svg>

<script>
/* -------------------------
   Utility: parse CSV text
   expects header containing 'source' and 'target' (case-insensitive)
   optional columns: size, color
   ------------------------- */
function parseCsvText(text){
  if(!text) return [];
  const rows = text.trim().split(/\r?\n/).map(r=>r.trim()).filter(Boolean);
  if(rows.length === 0) return [];
  const header = rows.shift().split(',').map(h=>h.trim().toLowerCase());
  const srcIdx = header.indexOf('source');
  const tgtIdx = header.indexOf('target');
  const sizeIdx = header.indexOf('size');
  const colorIdx = header.indexOf('color');
  if(srcIdx === -1 || tgtIdx === -1) throw new Error('CSV phải có header: source,target (có thể thêm size,color)');
  return rows.map(line=>{
    const cols = line.split(',').map(c=>c.trim());
    return {
      source: cols[srcIdx] || '',
      target: cols[tgtIdx] || '',
      size: sizeIdx !== -1 ? (Number(cols[sizeIdx]) || undefined) : undefined,
      color: colorIdx !== -1 ? (cols[colorIdx] || undefined) : undefined
    };
  }).filter(r => r.source && r.target);
}

/* -------------------------
   D3 force graph builder
   ------------------------- */
const svg = d3.select('#graph');
let width = window.innerWidth;
let height = window.innerHeight - document.querySelector('header').offsetHeight;
svg.attr('viewBox', `0 0 ${width} ${height}`);

let simulation = null;
let linkElems, nodeElems, nodeGroupElems;

function buildGraph(rows){
  // build unique nodes
  const nodesMap = {};
  rows.forEach(r=>{
    if(!nodesMap[r.source]) nodesMap[r.source] = { id: r.source, size: r.size || 18, color: r.color || '#5aa0ff' };
    if(!nodesMap[r.target]) nodesMap[r.target] = { id: r.target, size: r.size || 14, color: r.color || '#5aa0ff' };
  });
  const nodes = Object.values(nodesMap);
  const links = rows.map(r => ({ source: r.source, target: r.target }));

  // clear previous
  svg.selectAll('*').remove();

  // groups
  const linkG = svg.append('g').attr('class','links');
  const nodeG = svg.append('g').attr('class','nodes');

  linkElems = linkG.selectAll('line').data(links).join('line')
    .attr('stroke','#cfcfcf').attr('stroke-width',2).attr('stroke-linecap','round');

  nodeGroupElems = nodeG.selectAll('g').data(nodes).join('g').attr('class','node');

  nodeElems = nodeGroupElems.append('circle')
    .attr('r', d => Math.max(6, d.size))
    .attr('fill', d => d.color || '#5aa0ff')
    .attr('stroke','#2f2f2f').attr('stroke-width',0.9)
    .style('cursor','grab');

  nodeGroupElems.append('text')
    .attr('x', d => Math.max(8, d.size + 6))
    .attr('y', 4)
    .style('font-size','13px')
    .text(d=>d.id);

  // drag behavior with release on end
  function dragstarted(event, d) {
    if (!event.active && simulation) simulation.alphaTarget(0.3).restart();
    d.fx = d.x;
    d.fy = d.y;
  }
  function dragged(event, d) {
    d.fx = event.x;
    d.fy = event.y;
  }
  function dragended(event, d) {
    if (!event.active && simulation) simulation.alphaTarget(0.0);
    // release so node continues to be influenced by forces
    d.fx = null;
    d.fy = null;
  }
  const dragBehavior = d3.drag().on('start', dragstarted).on('drag', dragged).on('end', dragended);
  nodeGroupElems.call(dragBehavior);

  // click toggles fix/unfix (optional)
  nodeGroupElems.on('dblclick', (event, d) => {
    // dblclick to release fixed node
    d.fx = null; d.fy = null;
  }).on('click', (event, d) => {
    // single click => toggle fixed
    if (d.fx == null) { d.fx = d.x; d.fy = d.y; d3.select(event.currentTarget).classed('fixed', true); }
    else { d.fx = null; d.fy = null; d3.select(event.currentTarget).classed('fixed', false); }
  });

  // create simulation
  simulation = d3.forceSimulation(nodes)
    .force('link', d3.forceLink(links).id(d=>d.id).distance(120).strength(1))
    .force('charge', d3.forceManyBody().strength(-400))
    .force('center', d3.forceCenter(width/2, height/2))
    .alphaDecay(0.02) // chạy lâu hơn (mượt)
    .on('tick', ticked);

  // warm start
  simulation.alpha(0.8).restart();

  function ticked(){
    linkElems
      .attr('x1', d => d.source.x)
      .attr('y1', d => d.source.y)
      .attr('x2', d => d.target.x)
      .attr('y2', d => d.target.y);

    nodeGroupElems.attr('transform', d => `translate(${d.x},${d.y})`);
  }
}

/* -------------------------
   Auto-load CSV (network-data.csv) or fallback sample
   ------------------------- */
async function tryAutoLoad(){
  try {
    const resp = await fetch('./network-data.csv', {cache:'no-store'});
    if (!resp.ok) throw new Error('Not found');
    const txt = await resp.text();
    const rows = parseCsvText(txt);
    buildGraph(rows);
    console.log('Auto-loaded network-data.csv');
  } catch(err){
    console.warn('Auto-load failed:', err.message);
    // fallback sample
    const sample = `
source,target,size,color
Trung tam,San pham A,50,#ff6b4a
Trung tam,San pham B,36,#4aa7ff
San pham A,Chi tiet A1,12,#ffd36b
San pham A,Chi tiet A2,12,#ffd36b
San pham B,Chi tiet B1,10,#9ff3ff
San pham C,Chi tiet C1,8,#a3ffb5
San pham B,San pham C,20,#4aa7ff
`;
    const rows = parseCsvText(sample);
    buildGraph(rows);
  }
}

/* -------------------------
   manual file input
   ------------------------- */
document.getElementById('fileInput').addEventListener('change', function(e){
  const f = e.target.files[0]; if(!f) return;
  const reader = new FileReader();
  reader.onload = function(ev){
    try {
      const rows = parseCsvText(ev.target.result);
      buildGraph(rows);
    } catch(ex) {
      alert('Lỗi khi đọc CSV: ' + ex.message);
      console.error(ex);
    }
  };
  reader.readAsText(f);
});

/* -------------------------
   Controls: Fit, Toggle physics, Export PNG
   ------------------------- */
document.getElementById('fit').addEventListener('click', () => {
  if (!simulation) return;
  // nudge simulation so layout adjusts and recenters
  simulation.alpha(0.6).restart();
  setTimeout(()=> simulation.alphaTarget(0.0), 800);
});

let physicsOn = true;
const toggleBtn = document.getElementById('togglePhysics');
toggleBtn.addEventListener('click', () => {
  if (!simulation) return;
  physicsOn = !physicsOn;
  if (physicsOn) {
    simulation.alpha(0.6).restart();
    toggleBtn.textContent = 'Tạm dừng physics';
    toggleBtn.classList.remove('secondary');
  } else {
    // stop simulation by setting alphaTarget 0 and stop forces
    simulation.stop();
    toggleBtn.textContent = 'Tiếp tục physics';
    toggleBtn.classList.add('secondary');
  }
});

/* Export SVG->PNG */
document.getElementById('exportPng').addEventListener('click', () => {
  const svgEl = document.querySelector('#graph');
  const serializer = new XMLSerializer();
  const svgStr = serializer.serializeToString(svgEl);
  const blob = new Blob([svgStr], {type:'image/svg+xml;charset=utf-8'});
  const url = URL.createObjectURL(blob);
  const img = new Image();
  img.onload = () => {
    const canvas = document.createElement('canvas');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    const ctx = canvas.getContext('2d');
    ctx.fillStyle = '#f6f8fb';
    ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.drawImage(img, 0, 0);
    URL.revokeObjectURL(url);
    const link = document.createElement('a');
    link.download = 'network-graph.png';
    link.href = canvas.toDataURL('image/png');
    link.click();
  };
  img.onerror = (e) => { alert('Export PNG thất bại'); console.error(e); };
  img.src = url;
});

/* -------------------------
   Resize handling
   ------------------------- */
function resize(){
  width = window.innerWidth;
  height = window.innerHeight - document.querySelector('header').offsetHeight;
  svg.attr('viewBox', `0 0 ${width} ${height}`);
  if (simulation) simulation.force('center', d3.forceCenter(width/2, height/2));
}
window.addEventListener('resize', resize);

/* -------------------------
   Start: try auto-load CSV
   ------------------------- */
tryAutoLoad();
</script>
</body>
</html>
